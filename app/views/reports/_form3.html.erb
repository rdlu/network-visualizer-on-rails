<%= form_tag(performance_reports_path, :class => 'form-horizontal', :id => 'report-form3') do %>
    <div class="row-fluid">
        <div class="span5">
          <div class="control-group">
            <label for="probe-state" class="control-label">UF:</label>
            <div class="controls">
              <select multiple="true"  name = "by_state[]"  id="by-state" onchange="filterUFs()" >
                <option name="by_state" value="">Todas</option>
                <% Probe.states.each do |state| %>
                    <option name="by_state" value="<%= state.at(1) %>" <%= params[:by_state].to_s == state.at(1).to_s ? "selected=\"selected\"".html_safe : "" %>><%= state.at(1).upcase %></option>
                <% end %>
              </select>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="pop">POP: </label>
            <div class="controls"  >
              <select multiple="true"  name="by_pop[]" id="by_pop" onchange="setAllOpt(this.value,'pop')" >
                <option value="all">Todas</option>
                <%  Probe.pops.each do |p|  %>
                      <option value="<%= p %>"><%= p %></option>
                <% end %>
              </select>
            </div>
          </div>
        </div>
        <div class="span4">
            <div class="control-group">
                <label class="control-label"  for="by_type">Tipo de Destino: </label>
                <div class="controls">
                  <%= select :by_type,'', Probe.types,{}, :onchange => 'displayTypes(this.value)', :id=>"by_type"  %>
                </div>
            </div>
            <div id="ag_types" class="control-group" >
              <label class="control-label" for="by_conn_type">Tipo: </label>
              <div class="controls">
                <%= select :by_conn_type,'',[['Móvel','movel'],["Fixo","fixo"]]%>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="modem">Modem: </label>
                <div class="controls">
                  <select  name="by_modem[]" id="by_modem"  >
                    <%  Probe.modems.each do |p|  %>
                        <option value="<%= p %>"><%= p %></option>
                    <% end %>
                  </select>
                </div>
            </div>
          <div class="control-group">
            <label class="control-label" for="by_tech">Tecnologia: </label>
            <div class="controls">
              <select  name="by_tech[]" id="by_tech"  >
                <%  Probe.techs.each do |p|  %>
                    <option value="<%= p %>"><%= p %></option>
                <% end %>
              </select>
            </div>
          </div>
        </div>
    </div>

    <div class="row-fluid" style="border-top: 1px solid #CCCCCC;">
      <div class="span6">
          <div class="control-group" style="margin-top: 10px">
            <label class="control-label" for="destino">Sonda de Destino: </label>
            <div class="controls ">
              <select class="input-block-level" value="destination[id]" id="destino">
               <option> Selecione um UF primeiro...</option>
              <!--%= collection_select :destination, :id, Probe.order(:name).all, :id, :pretty_name_with_location, {:include_blank => "Selecione..."}, {:class => 'input-block-level',:id=>"destino"} %>
            -->
              </select>
            </div>
          </div>
          <div class="control-group">
            <label for="source_id" class="control-label">Sonda de Origem:</label>
            <div class="controls">
              <%= collection_select :source, :id, {}, :id, :pretty_name_with_location, {:include_blank => "Selecione a sonda de destino primeiro"}, {:class => 'input-block-level',:id=>"origem"} %>
            </div>
          </div>
      </div>
    </div>

    <div class="row-fluid" style="border-top: 1px solid #CCCCCC;">
      <div class="span12" style="margin-top: 10px">
        <div class="span5">
          <div class="control-group">
            <span class="control-label" >DNS:</span>
            <div class="controls">
              <select multiple="true" value="metrics[]" >
                <% Metric.all.each do |m|
                    if m.metric_type == "" || m.metric_type == "dns_details"
                %>
                    <option value="<%= m.id %>"><%= m.name %></option>
                <% end
                end %>
              </select>
            </div>
          </div>
          <div class="control-group">
            <span class="control-label" >Sites:</span>
            <div class="controls">
              <select multiple="true" value="sites[]">
                <option value="all">Todos</option>
                <% Site.all.each do |site| %>
                    <option value="<%= site.id %>"><%= site.url %></option>
                <% end %>
              </select>
            </div>
          </div>
        </div>
        <div class="span4">
          <div class="control-group">
            <span class="control-label" >Métricas:</span>
            <div class="controls">
              <select multiple="true" value="metrics[]">
                <% Metric.all.each do |m|
                    if m.metric_type == "active"
                %>
                    <option value="<%= m.id %>"><%= m.name %></option>
                <% end
                end %>
              </select>
            </div>
          </div>
          <div class="control-group">
            <span class="control-label" >Variação Métrica:</span>
            <div class="controls">
              <%= select :variation,'',[["Media"],["Minimo"],["Maximo"]] %>
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="horario">Horário: </label>
            <div class="controls">
              <%= select :horario,'',[['Últimas 24h','24'],["Últimas 48h",'48'],['Últimas 72h','72']]%>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row-fluid ">
      <div class="offset5 span4">
          <div class="control-group">
            <div class="controls">
              <input class="btn btn-primary btn-block " type="submit" name="add" id="report-add3" value="Adicionar"  data-toggle="collapse" data-target="#accordion_forms"/>
            </div>
          </div>
      </div>
    </div>

<% end %>

<script>

    function setAllOpt(value,id)
    {

        if (value == "" || value == 1 || value == "all"){
            var aux =  document.getElementById(id).options;
            aux.selected = false;
            for (var i =0; i < aux.length; i++){
                aux.item(i).selected = true;
            }
        }

        return  $('select#'+id).val();
    }

    function filterUFs(){
        var value = [];
        value = $('select#by-state').val();
        value = setAllOpt(value,'by-state');

        $.ajax({
            type: 'POST',
            url: "<%= probes_filter_destination_path %>",
            data: {
                'uf': value
            },
            success: function(data){
                var html = "";
                if (data == "")
                    html = "<option value='not'>Este UF não possui sonda.</option>";
                else{
                    html = html + "<option >Selecione...</option>";
                    for (dst in data){
                        html = html + "<option value='"+data[dst]["id"]+"'>"+data[dst]["name"]+"</option>";
                    }
                }

                $('#destino').html(html);

            }
        });

    }

    jQuery("#destino").change(function (evt) {
        var destination_id = evt.currentTarget.value;
        if (destination_id != '')
            jQuery.ajax("<%=probes_url %>/" + destination_id + "/sources", {
                success: function (result, status) {
                    var options = jQuery('#origem');
                    options.html('');
                    options.removeAttr('disabled');
                    jQuery.each(result, function (index, item) {
                        options.append($("<option />").val(item.id).text(item.name + ' (' + item.ipaddress + ') - ' + item.city + '/' + item.state.toUpperCase()));
                        jQuery("#origem").trigger('change');
                    });
                    if (result.length == 0) {
                        options.append($("<option />").val('').text('Essa sonda não recebe testes')).prop('disabled', true);
                    }
                },
                dataType: 'json'
            });
        else {
               jQuery('#origem').html('').append($("<option />").val('').text('Selecione a sonda de destino primeiro')).prop('disabled', true).trigger('change');

            }

    });

</script>